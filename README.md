# IPBan 文档

## 简介

IPBan 是一个基于 Meow 插件模板的 IP 封禁管理插件，为 Minecraft 基岩版服务器（LeviLamina/LiteLoaderBDS）提供完整的 IP 封禁系统。

支持在线/离线玩家封禁、IP 关联封禁、同 IP 多账号自动关联、换 IP 自动追踪、临时封禁（按天数）、联合封禁（UniteBan）上传、GUI 管理界面、后台命令操作、玩家搜索等功能。

- 作者：伊希娅
- 许可证：无
- 文件位置：`plugins/Meow/plugins/ipBan.js`

---

## 核心机制

1. 封禁玩家时自动记录其 IP、UUID、XUID、昵称
2. 封禁 IP 后，该 IP 下所有账号都无法进入服务器
3. 同 IP 的其他账号自动关联封禁
4. 被封禁玩家换 IP 后，新 IP 也会被自动封禁
5. 支持临时封禁，到期自动解封

---

## 数据存储

所有数据存储在 `./Meowdata/IPBan/` 目录下：

| 路径 | 说明 |
|------|------|
| `./Meowdata/IPBan/banData.json` | 封禁数据（被封禁的 IP、玩家、IP-玩家映射等） |
| `./Meowdata/IPBan/config.json` | 配置文件 |

### 封禁数据结构

```jsonc
{
  "bannedIPs": {},      // IP -> { reason, bannedAt, bannedBy, players: [xuid...], expireAt? }
  "bannedPlayers": {},  // XUID -> { name, uuid, xuid, ips: [], reason, bannedAt, bannedBy, expireAt? }
  "ipToPlayers": {},    // IP -> [xuid...]  每个 IP 下的所有玩家
  "playerToIPs": {},    // XUID -> [ip...]  每个玩家使用过的所有 IP
  "playerInfo": {}      // XUID -> { name, uuid, xuid, lastSeen }  所有进入过服务器的玩家信息
}
```

---

## 配置文件

`config.json` 默认配置：

```jsonc
{
  // 被封禁玩家被踢出时显示的消息
  "kickMessage": "§c你已被服务器封禁",

  // 关联封禁玩家被踢出时显示的消息
  "relatedKickMessage": "§c你的IP已被关联封禁",

  // 是否在控制台输出封禁日志
  "logToConsole": true
}
```

---

## 指令

| 指令 | 权限 | 说明 |
|------|------|------|
| `/ipban` | OP | 打开 GUI 管理界面 |
| `/ipbanc <玩家名> [原因]` | OP | 快速封禁玩家（支持后台/游戏内，支持离线玩家） |
| `/ipbanplayer <玩家选择器> [原因]` | OP | 快速封禁在线玩家（支持玩家选择器） |
| `/ipunban <玩家名/XUID/IP>` | OP | 解封玩家或 IP |
| `/ipbanlist` | OP | 在控制台/聊天栏查看封禁列表 |

---

## GUI 管理界面

通过 `/ipban` 打开主菜单，提供以下功能：

| 功能 | 说明 |
|------|------|
| 封禁在线玩家 | 从在线玩家列表中选择目标，输入原因和封禁时长 |
| 手动输入玩家名封禁 | 输入玩家名封禁，支持在线和离线玩家（从历史记录查找） |
| 查看封禁列表 | 查看被封禁的玩家和 IP，支持查看详情和解封操作 |
| 手动封禁 IP | 直接输入 IP 地址进行封禁，自动关联该 IP 下的所有已知玩家 |
| 查看玩家 IP 记录 | 查看所有玩家的 IP 使用历史，支持从记录中直接封禁/解封 |
| 搜索玩家 | 通过玩家名、IP、XUID、UUID 搜索玩家记录 |

### 封禁设置选项

在 GUI 封禁时可配置：

- 封禁原因（文本输入）
- 临时封禁天数（留空或 0 为永久封禁）
- 是否同时上传联合封禁（UniteBan）
- 联合封禁原因（留空则使用封禁原因）

---

## 封禁流程

### 封禁玩家

1. 记录目标玩家的 XUID、UUID、昵称、当前 IP
2. 封禁该玩家所有使用过的 IP
3. 自动关联封禁同 IP 下的其他玩家
4. 关联玩家的所有 IP 也会被封禁
5. 踢出目标玩家和所有关联玩家

### 玩家加入检查

1. 记录玩家 IP 关联信息
2. 清理过期的临时封禁
3. 检查 XUID 是否被封禁
4. 检查 IP 是否被封禁（新账号使用被封禁 IP 会自动关联封禁）
5. 检查被封禁玩家是否换了新 IP（新 IP 自动加入封禁列表）

### 解封玩家

1. 从 IP 封禁列表中移除该玩家
2. 如果某 IP 下没有其他被封禁玩家，移除该 IP 的封禁
3. 删除玩家封禁记录

### 解封 IP

1. 移除 IP 封禁记录
2. 检查受影响的玩家是否还有其他被封禁的 IP
3. 如果没有其他被封禁 IP，同时解封该玩家

---

## 临时封禁

- 封禁时可指定天数，到期自动解封
- 玩家加入服务器时自动检查并清理过期封禁
- 封禁详情中显示剩余天数

---

## 联合封禁（UniteBan）

封禁时可选择同时上传到 UniteBan 联合封禁系统：

- 通过执行 `cloudban "<玩家名>" "<原因>"` 命令上传
- 需要服务器已安装 UniteBan 插件
- 上传结果会反馈给操作者

---

## 事件监听

| 事件 | 处理 |
|------|------|
| `onPreJoin` | 记录 IP 关联、检查过期封禁、检查封禁状态、检查换 IP |
| `onJoin` | 更新玩家 IP 记录 |
